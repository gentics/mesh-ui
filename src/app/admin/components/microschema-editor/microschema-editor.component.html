<form [formGroup]="formGroup"
      class="formgroup row">

    <h2 class="section-header medium-10 columns">Microschema Properties:</h2>
    <div class="input-container small-12 medium-10 columns">
        <gtx-input type="text"
                   label="Microschema Name"
                   formControlName="name"></gtx-input>
        <div class="input-note">
            <p [@statusAnim]
               *ngIf="getFormControlErrorOfType('name', 'required')"
               class="invalid">required</p>
            <p [@statusAnim]
               *ngIf="getFormControlErrorOfType('name', 'pattern')"
               class="invalid">Invalid characters: alphanumeric and underscore only</p>
            <p [@statusAnim]
               *ngIf="getFormControlErrorOfType('name', 'conflict')"
               class="invalid">This name is already in use by another schema</p>
        </div>
    </div>

    <div class="small-12 medium-2 columns">
        <div class="checkbox-wrapper">
            <div>
                <gtx-checkbox label="Container"
                              formControlName="container"></gtx-checkbox>
            </div>
        </div>
    </div>

    <gtx-input type="text"
               class="small-12 medium-12 columns"
               label="Description"
               formControlName="description"></gtx-input>

    <div class="input-container small-12 medium-4 columns">
        <gtx-select formControlName="displayField"
                    label="Display Field"
                    title="Select the name of the field whose value will be used as the node display (e. g. field 'ISBN' or field 'Title' on a schema 'Book' )">
            <gtx-option *ngFor="let field of displayFields"
                        [value]="field.value">{{ field.label }}</gtx-option>
        </gtx-select>
        <div class="input-note">
            <p [@statusAnim]
               *ngIf="getFormControlErrorOfType('displayField', 'required')"
               class="invalid">required</p>
            <p class="warning"
               [@statusAnim]
               *ngIf="!hasDisplayFields()">Create valid schema field of type 'binary' or 'string'</p>
        </div>
    </div>

    <div class="input-container small-12 medium-4 columns">
        <gtx-select formControlName="segmentField"
                    label="Segment Field">
            <gtx-option *ngFor="let field of segmentFields"
                        [value]="field.value">{{ field.label }}</gtx-option>
        </gtx-select>
        <div class="input-note">
            <p class="warning"
               [@statusAnim]
               *ngIf="!hasSegmentFields()">Create valid schema field of type 'binary' or 'string'</p>
        </div>
    </div>


    <div class="input-container small-12 medium-4 columns">
        <gtx-select formControlName="urlFields"
                    [multiple]="true"
                    label="URL Fields">
            <gtx-option *ngFor="let field of urlFields"
                        [value]="field.value">{{ field.label }}</gtx-option>
        </gtx-select>
        <div class="input-note">
            <p class="warning"
               [@statusAnim]
               *ngIf="!hasUrlFields()">Create valid schema field of type 'string' or type 'list' of type 'string'</p>
        </div>
    </div>

    <br>
    <div class="section-header-fields medium-12 columns">
        <h2>Microschema Fields:</h2>
        <gtx-button size="small"
                    (click)="fieldAdd()">
            <icon left>add</icon>New Field
        </gtx-button>
    </div>

    <div [@ngForAnimParent]
         class="schema-field small-12 medium-12 columns"
         *ngFor="let field of schemaFields.controls; let i = index">

        <form [@ngForAnimChild]
              [formGroup]="field">
            <div class="field-header">
                <h3>{{field.value?.name}}</h3>
            </div>
            <div class="row">
                <div class="small-12 medium-3 columns">
                    <gtx-input type="text"
                               label="Field Name"
                               formControlName="name"></gtx-input>
                    <div class="input-note">
                        <p [@statusAnim]
                           *ngIf="getFormControlInArrayErrorOfType(i, 'name', 'required')"
                           class="invalid">required</p>
                        <p [@statusAnim]
                           *ngIf="getFormControlInArrayErrorOfType(i, 'name', 'pattern')"
                           class="invalid">Invalid characters: alphanumeric and underscore only</p>
                        <p [@statusAnim]
                           *ngIf="getFormControlInArrayErrorOfType(i, 'name', 'duplicate')"
                           class="invalid">Duplicate content</p>
                    </div>
                </div>

                <div class="small-12 medium-3 columns">
                    <gtx-textarea label="Field Label"
                                  formControlName="label"></gtx-textarea>
                </div>

                <div class="input-container small-12 medium-2 columns">
                    <gtx-select formControlName="type"
                                label="Field Type">
                        <gtx-option *ngFor="let type of schemaFieldTypes"
                                    [value]="type.value">{{ type.label }}</gtx-option>
                    </gtx-select>
                    <div class="input-note">
                        <p [@statusAnim]
                           *ngIf="getFormControlInArrayErrorOfType(i, 'type', 'required')"
                           class="invalid">required</p>
                    </div>
                </div>

                <div class="small-12 medium-2 columns">
                    <div class="checkbox-wrapper">
                        <div>
                            <gtx-checkbox label="required"
                                          formControlName="required"></gtx-checkbox>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- INPUT DEPENDING ON listType START -->

                <!-- {{ 'modal.create_project_schema_label' | i18n }} -->
                <div class="small-12 medium-4 columns">
                    <gtx-select [hidden]="field.value.type !== 'list'"
                                formControlName="listType"
                                label="List Type">
                        <gtx-option *ngFor="let type of schemaFieldListTypes"
                                    [value]="type.value">{{ type.label }}</gtx-option>
                    </gtx-select>
                    <div class="input-note">
                        <p [@statusAnim]
                           *ngIf="getFormControlInArrayErrorOfType(i, 'listType', 'required')"
                           class="invalid">required</p>
                    </div>
                </div>

                <div [hidden]="field.value.type !== 'node' && field.value.listType !== 'node'"
                     class="input-container small-12 medium-7 columns">
                    <gtx-select [value]="allowValueGetAt(i)"
                                (change)="allowValueSetAt(i, $event)"
                                [multiple]="true"
                                label="Allowed Schemas">
                        <gtx-option *ngFor="let schema of (allSchemas$ | async)"
                                    [value]="schema.name">{{ schema.name }}</gtx-option>
                    </gtx-select>
                </div>

                <div [hidden]="field.value.type !== 'micronode' && field.value.listType !== 'micronode'"
                     class="input-container small-12 medium-7 columns">
                    <gtx-select [value]="allowValueGetAt(i)"
                                (change)="allowValueSetAt(i, $event)"
                                [multiple]="true"
                                label="Allowed Microschemas">
                        <gtx-option *ngFor="let microschema of (allMicroschemas$ | async)"
                                    [value]="microschema.name">{{ microschema.name }}</gtx-option>
                    </gtx-select>
                </div>

                <div [hidden]="field.value.type !== 'string' && field.value.listType !== 'string'"
                     class="string-bar small-12 medium-7 columns">
                    <label class="ng-star-inserted">Allowed Strings</label>
                    <gtx-search-bar formControlName="allow"
                                    (search)="allowValueOnStringInputAddAt(i, $event)"
                                    (keydown.backspace)="allowValueRemoveLastAt(i)"
                                    placeholder="Type and press ENTER or SPACE to add allowed value"
                                    title="Type and press ENTER or SPACE to add allowed value; press BACKSPACE to remove existing entry"
                                    (clear)="formControlInArrayClear(i, 'allow')">

                        <mesh-chip *ngFor="let item of allowValues[i]"
                                   (removeClick)="allowValueRemoveAt(i, item)">
                            {{ item }}
                        </mesh-chip>
                    </gtx-search-bar>
                </div>

                <!-- INPUT DEPENDING ON listType END -->
            </div>
        </form>
        <div class="button-close">
            <gtx-button icon
                        type="secondary"
                        title="remove field"
                        (click)="fieldDelete(field, i)">
                <icon>close</icon>
            </gtx-button>
        </div>
        <!-- <div class="button-moveup">
            <gtx-button icon
                        type="secondary"
                        title="move field one field up"
                        (click)="fieldMoveUp(i)">
                <icon>keyboard_arrow_up</icon>
            </gtx-button>
        </div>
        <div class="button-movedown">
            <gtx-button icon
                        type="secondary"
                        title="move field one field down"
                        (click)="fieldMoveDown(i)">
                <icon>keyboard_arrow_down</icon>
            </gtx-button>
        </div> -->
        <div class="button-add">
            <gtx-button icon
                        type="secondary"
                        title="insert field"
                        (click)="fieldAddAt(i + 1)">
                <icon>add</icon>
            </gtx-button>
        </div>
    </div>

    <div *ngIf="schemaFields.value.length === 0"
         class="small-12 medium-12 columns">
        <p class="warning">This Microschema has no schema fields</p>
    </div>
</form>

<br>

<div class="schema-controls small-12 medium-12 columns">
    <gtx-button [disabled]="!(formGroupIsValid() && schemaSaveIsPermitted())"
                (click)="schemaSave()"
                [title]="schemaSaveIsPermitted() ? 'Save' : 'You do not have the required privilege to save'">
        <icon left>save</icon>Save
    </gtx-button>

    <gtx-button [hidden]="!schemaDeleteButtonIsDisplayed()"
                [disabled]="!schemaDeleteIsPermitted()"
                (click)="schemaDelete()"
                [title]="schemaDeleteIsPermitted() ? 'Delete' : 'You do not have the required privilege to delete'">
        <icon left>delete</icon>Delete
    </gtx-button>
</div>
